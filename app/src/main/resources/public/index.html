<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Lucene Word Cloud</title>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://unpkg.com/d3-cloud/build/d3.layout.cloud.js"></script>
    <script src="https://unpkg.com/mustache@4.2.0/mustache.min.js"></script>
    <style>
      body {
        position: relative;
        font-family: "Helvetica Neue", sans-serif;
        width: 960px;
        margin: auto;
        margin-bottom: 1em;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div id="wordcloud"></div>

    <form id="query-form">
        <input type="text" id="query-input" placeholder="Enter query" required>
        <button type="submit">Search</button>
    </form>

    <div id="results-container"></div>

    <script id="table-template" type="x-tmpl-mustache">
      <table>
        <tbody>
          {{#hits}}
            <tr>
              <td>{{book}} {{chapter}}:{{verse}} {{text}}</td>
            </tr>
          {{/hits}}
        </tbody>
      </table>
    </script>

    <script>
      // based on the https://gist.github.com/joews/9697914

      // Encapsulate the word cloud functionality
      function wordCloud(selector) {

          var fill = d3.scale.category20b();

          //Construct the word cloud's SVG element
          var svg = d3.select(selector).append("svg")
              .attr("width", 960)
              .attr("height", 600)
              .append("g")
              .attr("transform", "translate(480,300)");


          //Draw the word cloud
          function draw(words) {
              var cloud = svg.selectAll("g text")
                              .data(words, function(d) { return d.word; })

              //Entering words
              cloud.enter()
                  .append("text")
                  .style("font-family", "Impact")
                  .style("fill", function(d, i) { return fill(i); })
                  .attr("text-anchor", "middle")
                  //.attr('font-size', 1)
                  .text(function(d) { return d.word; });

              //Entering and existing words
              cloud
                  .transition()
                      .duration(600)
                      .style("font-size", function(d) { return d.score + "px"; })
                      .attr("transform", function(d) {
                          return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                      })
                      .style("fill-opacity", 1);

              //Exiting words
              cloud.exit()
                  .transition()
                      .duration(200)
                      .style('fill-opacity', 1e-6)
                      //.attr('font-size', 1)
                      .remove();
          }

          //Use the module pattern to encapsulate the visualisation code. We'll
          // expose only the parts that need to be public.
          return {


              //Recompute the word cloud for a new set of words. This method will
              // asycnhronously call draw when the layout has been computed.
              //The outside world will need to call this function, so make it part
              // of the wordCloud return value.
              update: function(words) {

                  // TODO tidy the scaling / sizing logic

                  const maxScore = Math.max(...words.map(w => w.score));
                  const minScore = Math.min(...words.map(w => w.score));

                  const desiredMax = 10000;
                  const scale = desiredMax / maxScore;
                  const scaledWords = words.map(w => ({"word": w.word, "score": Math.sqrt(w.score * scale) }));

                  d3.layout.cloud()
                      .size([960, 600])
                      .words(scaledWords)
                      .padding(2)
                      .spiral("archimedean")
                      .rotate(function() { return (~~(Math.random() * 6) - 3) * 30; })
                      .font("Impact")
                      .text(function(d) { return d.word; })
                      .fontSize(function(d) { return d.score; })
                      .on("end", draw)
                      .start();
              }
          }

      }

      //Create a new instance of the word cloud visualisation.
      var myWordCloud = wordCloud('#wordcloud');

      // ----------------------------------------------------------------------------------------------------------

      document.getElementById('query-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const query = document.getElementById('query-input').value;
        const encodedQuery = encodeURIComponent(query);
        const url = `/search?q=${encodedQuery}`;

        try {
          const response = await fetch(url);

          if (!response.ok) {
            document.getElementById('results-container').innerText = 'Error fetching results.';
            return;
          }

          const data = await response.json();
          myWordCloud.update(data.topWords);
          renderTable(data);
        } catch (err) {
          document.getElementById('results-container').innerText = 'Network or server error.';
          console.error(err);
        }
      });

      function renderTable(data) {
        const template = document.getElementById('table-template').innerHTML;
        const html = Mustache.render(template, data);

        document.getElementById('results-container').innerHTML = html;
      }

    </script>

  </body>
</html>
