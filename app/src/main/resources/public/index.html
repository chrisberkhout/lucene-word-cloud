<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Lucene Word Cloud</title>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://unpkg.com/d3-cloud/build/d3.layout.cloud.js"></script>
    <script src="https://unpkg.com/mustache@4.2.0/mustache.min.js"></script>
    <style>
      body {
        position: relative;
        font-family: "Helvetica Neue", sans-serif;
        width: 960px;
        margin: auto;
        margin-bottom: 1em;
        margin-top: 15px;

        justify-content: center;
        align-items: center;
      }

      /* facets styling */
      .bar {
        fill: silver;
      }
      .label {
        font-size: 9px;
        fill: dimgray;
        text-anchor: end;
      }

      /* search bar style */

      #query {
        margin-top: 45px;
        margin-bottom: 15px;
      }

      #query-form {
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 4px;
        display: flex;
        width: 640px;
        margin: auto;
      }

      #query-input {
        border: none;
        background: transparent;
        padding: 8px 12px;
        font-size: 16px;
        outline: none;
        flex: 1;
      }

      #query-button {
        border: none;
        background: transparent;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 16px;
        float: right;
      }

      #query-button:hover {
        background-color: #e0e0e0;
        border-radius: 4px;
      }

      /* results style */

      #results-description {
        font-family: "Helvetica Neue", sans-serif;
        font-size: 14px;
        margin: auto;
        margin-top: 15px;
        margin-bottom: 30px;
        text-align: center;
        color: dimgray;
      }

      #results {
        margin-bottom: 50px;
      }
      table {
        font-family: Georgia, serif;
        border-spacing: 0 8px;
      }

      td.ref {
        width: 160px;
        color: saddleBrown;
        vertical-align: top;
        text-align: right;
        padding-right: 20px;
      }

      td.text {
        color: #444;
        font-size: 0.95em;
        padding-right: 30px;
      }

    </style>
  </head>
  <body>
    <div id="wordcloud"></div>

    <div id="facets">
      <svg width="960" height="180"></svg>
    </div>

    <div id="query">
      <form id="query-form">
        <input id="query-input" type="text" placeholder="Enter query" required>
        <button id="query-button" type="submit">üîç</button>
      </form>
    </div>

    <div id="results-description">
    </div>

    <script id="results-description-template" type="x-tmpl-mustache">
      {{totalHits}} verse{{^singleHit}}s{{/singleHit}} found in
      {{time}}ms{{^showingAll}}, showing {{showingNum}}{{/showingAll}}
    </script>

    <div id="results">
    </div>

    <script id="results-template" type="x-tmpl-mustache">
      <table>
        <tbody>
          {{#hits}}
            <tr>
              <td class="ref">{{book}} {{chapter}}:{{verse}}</td>
              <td class="text">{{text}}</td>
            </tr>
          {{/hits}}
        </tbody>
      </table>
    </script>

    <script>

      function drawFacets(data) {
        var svg = d3.select("#facets svg");
        var width = 960;
        var height = 100;
        var barPadding = 1;
        var barWidth = width / 66;

        var yScale = d3.scale.linear().range([0, height]);
        yScale.domain([0, d3.max(data, d => d)]);

        // Bars
        var bars = svg.selectAll("rect").data(data, (d, i) => i);

        bars.enter()
          .append("rect")
          .attr("x", function(d, i) { return i * barWidth; })
          .attr("y", function(d) { return height - yScale(d); })
          .attr("width", barWidth - barPadding)
          .attr("height", function(d) { return yScale(d); })
          .attr("class", "bar");

        bars.transition()
          .duration(500)
          .attr("y", function(d) { return height - yScale(d); })
          .attr("height", function(d) { return yScale(d); });

        bars.exit().remove();

        // Labels
        var labelStrings = ["Genesis","Exodus","Leviticus","Numbers","Deuteronomy","Joshua","Judges","Ruth","1 Samuel","2 Samuel","1 Kings","2 Kings","1 Chronicles","2 Chronicles","Ezra","Nehemiah","Esther","Job","Psalms","Proverbs","Ecclesiastes","Song of Solomon","Isaiah","Jeremiah","Lamentations","Ezekiel","Daniel","Hosea","Joel","Amos","Obadiah","Jonah","Micah","Nahum","Habakkuk","Zephaniah","Haggai","Zechariah","Malachi","Matthew","Mark","Luke","John","Acts","Romans","1 Corinthians","2 Corinthians","Galatians","Ephesians","Philippians","Colossians","1 Thessalonians","2 Thessalonians","1 Timothy","2 Timothy","Titus","Philemon","Hebrews","James","1 Peter","2 Peter","1 John","2 John","3 John","Jude","Revelation"];

        svg.selectAll("text")
          .data(labelStrings)
          .enter()
          .append("text")
            .attr("transform", (d, i) => {
              const x = i * barWidth + barWidth / 2;
              const y = height + 3;
              return `translate(${x}, ${y}) rotate(-90)`;
            })
            .attr("dy", "0.35em")
            .attr("class", "label")
            .text(d => d);
      }


      // based on the https://gist.github.com/joews/9697914

      // Encapsulate the word cloud functionality
      function wordCloud(selector) {

          var fill = d3.scale.category20b();

          //Construct the word cloud's SVG element
          var svg = d3.select(selector).append("svg")
              .attr("width", 960)
              .attr("height", 500)
              .append("g")
              .attr("transform", "translate(480,250)");


          //Draw the word cloud
          function draw(words) {
              var cloud = svg.selectAll("g text")
                              .data(words, function(d) { return d.word; })

              //Entering words
              cloud.enter()
                  .append("text")
                  .style("font-family", "Impact")
                  .style("fill", function(d, i) { return fill(i); })
                  .attr("text-anchor", "middle")
                  //.attr('font-size', 1)
                  .text(function(d) { return d.word; });

              //Entering and existing words
              cloud
                  .transition()
                      .duration(600)
                      .style("font-size", function(d) { return d.score + "px"; })
                      .attr("transform", function(d) {
                          return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                      })
                      .style("fill-opacity", 1);

              //Exiting words
              cloud.exit()
                  .transition()
                      .duration(200)
                      .style('fill-opacity', 1e-6)
                      //.attr('font-size', 1)
                      .remove();
          }

          //Use the module pattern to encapsulate the visualisation code. We'll
          // expose only the parts that need to be public.
          return {


              //Recompute the word cloud for a new set of words. This method will
              // asycnhronously call draw when the layout has been computed.
              //The outside world will need to call this function, so make it part
              // of the wordCloud return value.
              update: function(words) {

                  // TODO tidy the scaling / sizing logic

                  const maxScore = Math.max(...words.map(w => w.score));

                  const desiredMax = 80;
                  const scale = desiredMax * desiredMax / maxScore;
                  const scaledWords = words.map(w => ({"word": w.word, "score": Math.sqrt(w.score * scale) }));

                  d3.layout.cloud()
                      .size([960, 500])
                      .words(scaledWords)
                      .padding(2)
                      .spiral("archimedean")
                      .rotate(function() { return (~~(Math.random() * 6) - 3) * 30; })
                      .font("Impact")
                      .text(function(d) { return d.word; })
                      .fontSize(function(d) { return d.score; })
                      .on("end", draw)
                      .start();
              }
          }

      }

      //Create a new instance of the word cloud visualisation.
      var myWordCloud = wordCloud('#wordcloud');

      // initial setup
      (async function () {
        const initUrl = `http://localhost:7070/search`;
        const initResponse = await fetch(initUrl);
        const initData = await initResponse.json();
        myWordCloud.update(initData.topWords);
        drawFacets(initData.hitsByBook);
      })();

      // ----------------------------------------------------------------------------------------------------------

      document.getElementById('query-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const query = document.getElementById('query-input').value;
        const encodedQuery = encodeURIComponent(query);
        const url = `/search?q=${encodedQuery}`;

        try {
          const response = await fetch(url);

          if (!response.ok) {
            document.getElementById('results').innerText = 'Error fetching results.';
            return;
          }

          const data = await response.json();
          myWordCloud.update(data.topWords);
          drawFacets(data.hitsByBook);

          data.singleHit = data.hits.length == 1;
          data.showingAll = data.hits.length == data.totalHits;
          data.showingNum = data.hits.length;

          document.getElementById('results-description').innerHTML = Mustache.render(
            document.getElementById('results-description-template').innerHTML,
            data
          );
          document.getElementById('results').innerHTML = Mustache.render(
            document.getElementById('results-template').innerHTML,
            data
          );

        } catch (err) {
          document.getElementById('results-description').innerText = 'Network or server error';
          document.getElementById('results').innerText = "";
          console.error(err);
        }
      });

    </script>

  </body>
</html>
